# Lab8 Report
#### 计34 马也 2013011365
---

## 练习一

> 完成读文件操作的实现

### 读文件整体流程

如果用户在用户态使用 `read()` 函数读取文件内容，则经历了以下四层：

1. 通用文件访问接口层： read -> sys_read -> syscall -> sysread -> sysfile_read
2. VFS层：循环调用file_read 函数，将内容读取到buffer之中。file_read 调用了SFS层的vop_read函数
3. SFS层：在SFS中。vop_read实际上绑定到了sfs_read，其负责真正的读取文件，本次实验中要实现的就是sfs_read调用的子函数 sfs_io_nolock
4. 设备层：sfs_read中调用了dio，实际最终指向了ide_readsector

在本次练习中，我们需要完成的就是SFS层的读取文件这一函数，该函数的流程为：

1. 一些初始化工作，包括计算offset、len，和一些边界情况的判断
2. 如果offset没有和block大小对齐，则先读取开头的一小段
3. 读取中间的n个整block
4. 如果endpos没有和block大小对齐，则读取最后的一小段

在真正读取的时候，有两个子步骤，首先调用 `sfs_bmap_load_nolock` 得到该block对应的 `disk_inode` 是多少，然后再使用 `sfs_buf_op` 对这个 `disk_inode` 进行读取即可。


### PIPE机制的概要设计



首先，对于ucore顶层上面的设计，我觉得使用设备文件是比较合适的，即仿照stdin和stdout这两个设备文件，设置添加管道这一设备文件的接口，这样就可以让上层有着跟文件读写、打开、关闭等等一样的接口信息，甚至连实现中的 inode 都可以共用。

经过查阅资料，我发现UNIX系统中有两种管道，一种是无名的（仅在fork得到父子进程中间共享），另一种是有名的（named_pipe）。前者的话由于父子进程共享文件描述符，所以刚刚提到的设备文件的方式天然的可以实现二者的共同访问；而后者则需要提供一个根据名称寻找管道名的接口，并返回相应的文件描述符。

对于设备文件读写接口的具体实现，可以开一定大小的内存空间，然后使用循环队列进行读取即可。为了实现同步互斥，可以采用信号量的方式，当头尾指针重合时，发出wait操作，而当有数据进入时，则signal以唤醒等待的进程，其类似于生产者消费者模型，只不过把数量变成了两个指针罢了。


---

## 练习2

> 完成基于文件系统的执行程序机制的实现

本练习要求扩充在之前的lab中实现的 load_icode 函数，由于之前没有文件系统，所有的用户文件都被直接放入了内存之中，因此 load_icode 只需要从内存中的 binary 指针的位置开始读取就可以了。在lab8中，由于添加了文件系统，我们需要修改其中关于读取二进制文件的步骤，并添加传入参数的设置。读取部分的具体改动如下：

* 添加 load_icode_read 辅助函数，负责从用户文件中读取从offset开始，长度为len的内容到buffer之中
* 将之前的 binary 指针变成了 elf指针，并调用load_icode_read读取一个elfhdr大小
* 解析elfhdr，得到每个段的起始位置和大小，再分别调用 load_icode_read 读取到buffer之中
* 拷贝读取出来的段到内存的相应位置

从中我们可以看出，改动的部分不是很多，仅仅是将之前已经放在内存中的文件变成需要时从文件中读取，其余部分一致。

接下来要将传入参数 argc和 argv设置好，需要注意的是，根据C程序的设置，栈上面的参数argv对应的是实际字符串的地址，而不是真实字符串。具体流程为：首先计算argv的总大小，将其按序拷贝到栈上，并保存其在栈上的地址；接着将这些**地址**依次压栈，并将argc压栈；最后，修改用户栈栈顶的位置即可。

### Unix的硬链接和软链接机制

由于之前在那个SPOC练习上面实现过硬链接和软连接（Python代码），对于Ucore上面的实现也就不那么困难了。

首先是硬链接：对于创建硬链接的请求，我们将文件file结构体的inode指向的数据块绑定到被链接的那个文件的inode指向的数据库上面，即二者共用这个同一个数据块，同时在结构体中添加引用计数，这样在删除的时候只对最后一次删除才真正删除掉数据块，否则仅仅删除掉inode即可

软连接的实现就更简单了，和普通文件没有太大的区别，同样创建inode和数据块，只不过在数据块中存放目标文件的完整路径和文件名，同时增加一个type，指明其是软连接即可。读写操作都额外查找一下被链接的真实inode即可。

## 重要知识点

1. 文件系统的结构，从上到下4层
2. SFS存储的结构：superblock，root_dir inode，freemap，数据和inode
3. 文件操作流程（从系统调用一直到dio操作）
4. 软连接、硬链接的区别
